"""
LTTng-UST Test Suite

This package contains all tests for LTTng-UST:
- Unit tests: Test individual components (msgpack, ringbuffer, etc.)
- Compile tests: Verify tracepoint examples compile and work
- Regression tests: Test for specific bugs and ABI compatibility
- Benchmark tests: Performance testing

Note: Most tests are marked 'manual' due to URCU atomic builtin issues on ARM64.
The working test is test_gcc_weak_hidden.
"""

load("@rules_cc//cc:defs.bzl", "cc_binary", "cc_library", "cc_test")

package(default_visibility = ["//visibility:public"])

# Configuration defines for tests
COMMON_DEFINES = [
    "_GNU_SOURCE",
]

# Common compiler options for tests
COMMON_COPTS = select({
    "@platforms//cpu:aarch64": [
        "-std=gnu99",
        "-fno-strict-aliasing",
        "-Wall",
        "-Wextra",
        "-Wno-sign-compare",
        "-Wno-missing-field-initializers",
        "-fPIC",
        "-D_LGPL_SOURCE",
        "-march=armv8-a",
        "-D__GCC_HAVE_SYNC_COMPARE_AND_SWAP_1",
        "-D__GCC_HAVE_SYNC_COMPARE_AND_SWAP_2",
        "-D__GCC_HAVE_SYNC_COMPARE_AND_SWAP_4",
        "-D__GCC_HAVE_SYNC_COMPARE_AND_SWAP_8",
    ],
    "//conditions:default": [
        "-std=gnu99",
        "-fno-strict-aliasing",
        "-Wall",
        "-Wextra",
        "-Wno-sign-compare",
        "-Wno-missing-field-initializers",
        "-fPIC",
        "-D_LGPL_SOURCE",
        "-D__GCC_HAVE_SYNC_COMPARE_AND_SWAP_1",
        "-D__GCC_HAVE_SYNC_COMPARE_AND_SWAP_2",
        "-D__GCC_HAVE_SYNC_COMPARE_AND_SWAP_4",
        "-D__GCC_HAVE_SYNC_COMPARE_AND_SWAP_8",
    ],
})

###############################################################################
# Test Utilities - TAP (Test Anything Protocol) library
###############################################################################

# TAP library for test framework
cc_library(
    name = "tap",
    srcs = ["utils/tap.c"],
    hdrs = ["utils/tap.h"],
    copts = COMMON_COPTS,
    includes = ["utils"],
    local_defines = COMMON_DEFINES,
)

###############################################################################
# Unit Tests
###############################################################################

# Test for GCC weak/hidden symbols - âœ… WORKS
cc_test(
    name = "test_gcc_weak_hidden",
    srcs = [
        "unit/gcc-weak-hidden/b.c",
        "unit/gcc-weak-hidden/b.h",
        "unit/gcc-weak-hidden/libgcc-wh.h",
        "unit/gcc-weak-hidden/libgcc-wh1.c",
        "unit/gcc-weak-hidden/libgcc-wh2.c",
        "unit/gcc-weak-hidden/main.c",
    ],
    copts = COMMON_COPTS,
    local_defines = COMMON_DEFINES,
    deps = [":tap"],
)

# Manual: Hidden symbols in msgpack library prevent linking
cc_test(
    name = "test_msgpack",
    srcs = ["unit/libmsgpack/test_msgpack.c"],
    copts = COMMON_COPTS,
    local_defines = COMMON_DEFINES,
    tags = ["manual"],
    deps = [
        ":tap",
        "@lttng-ust//:msgpack",
    ],
)

# Manual: ust_safe_snprintf has hidden visibility
cc_test(
    name = "test_snprintf",
    srcs = ["unit/snprintf/snprintf.c"],
    copts = COMMON_COPTS,
    local_defines = COMMON_DEFINES,
    tags = ["manual"],
    deps = [
        ":tap",
        "@lttng-ust//:snprintf",
    ],
)

# Manual: Depends on common library which has URCU issues
cc_test(
    name = "test_pthread_name",
    srcs = ["unit/pthread_name/pthread_name.c"],
    copts = COMMON_COPTS,
    local_defines = COMMON_DEFINES,
    tags = ["manual"],
    deps = [
        ":tap",
        "@lttng-ust//:common",
    ],
)

# Manual: Depends on lttng-ust which has URCU issues
cc_test(
    name = "test_ust_error",
    srcs = ["unit/ust-error/ust-error.c"],
    copts = COMMON_COPTS,
    local_defines = COMMON_DEFINES,
    tags = ["manual"],
    deps = [
        ":tap",
        "@lttng-ust//:lttng-ust",
    ],
)

# Manual: Depends on lttng-ust which has URCU issues
cc_test(
    name = "test_ust_utils",
    srcs = [
        "unit/ust-utils/ust-utils.c",
        "unit/ust-utils/ust-utils-common.h",
    ],
    copts = COMMON_COPTS,
    local_defines = COMMON_DEFINES,
    tags = ["manual"],
    deps = [
        ":tap",
        "@lttng-ust//:lttng-ust",
    ],
)

# Manual: Depends on ringbuffer which has URCU issues
cc_test(
    name = "test_ringbuffer_shm",
    srcs = ["unit/libringbuffer/shm.c"],
    copts = COMMON_COPTS,
    local_defines = COMMON_DEFINES,
    tags = ["manual"],
    deps = [
        ":tap",
        "@lttng-ust//:ringbuffer",
    ],
)

# Manual: Depends on common library which has URCU issues
cc_test(
    name = "test_get_cpu_mask_from_sysfs",
    srcs = ["unit/libcommon/get_cpu_mask_from_sysfs.c"],
    copts = COMMON_COPTS,
    local_defines = COMMON_DEFINES,
    tags = ["manual"],
    deps = [
        ":tap",
        "@lttng-ust//:common",
    ],
)

# Manual: Depends on common library which has URCU issues
cc_test(
    name = "test_get_max_cpuid_from_mask",
    srcs = ["unit/libcommon/test_get_max_cpuid_from_mask.c"],
    copts = COMMON_COPTS,
    local_defines = COMMON_DEFINES,
    tags = ["manual"],
    deps = [
        ":tap",
        "@lttng-ust//:common",
    ],
)

# Manual: Depends on common library which has URCU issues
cc_test(
    name = "test_get_max_cpuid_from_sysfs",
    srcs = ["unit/libcommon/get_max_cpuid_from_sysfs.c"],
    copts = COMMON_COPTS,
    local_defines = COMMON_DEFINES,
    tags = ["manual"],
    deps = [
        ":tap",
        "@lttng-ust//:common",
    ],
)

# Manual: Depends on common library which has URCU issues
cc_test(
    name = "test_get_possible_cpus_array_len",
    srcs = ["unit/libcommon/test_get_possible_cpus_array_len.c"],
    copts = COMMON_COPTS,
    local_defines = COMMON_DEFINES,
    tags = ["manual"],
    deps = [
        ":tap",
        "@lttng-ust//:common",
    ],
)

# Manual: Depends on common library which has URCU issues
cc_test(
    name = "test_ust_elf",
    srcs = ["unit/ust-elf/ust-elf.c"],
    copts = COMMON_COPTS,
    data = glob([
        "unit/ust-elf/data/**/*.elf",
        "unit/ust-elf/data/**/*.debug",
        "unit/ust-elf/data/pic/*",
    ]),
    local_defines = COMMON_DEFINES,
    tags = ["manual"],
    deps = [
        ":tap",
        "@lttng-ust//:common",
    ],
)

###############################################################################
# Compile Tests - All marked manual due to URCU issues
###############################################################################

# Manual: Depends on lttng-ust which has URCU issues
cc_test(
    name = "api0_hello",
    srcs = [
        "compile/api0/hello/hello.c",
        "compile/api0/hello/tp.c",
        "compile/api0/hello/ust_tests_hello.h",
    ],
    copts = COMMON_COPTS,
    local_defines = COMMON_DEFINES,
    tags = ["manual"],
    deps = [
        "@lttng-ust//:lttng-ust",
        "@lttng-ust//:lttng-ust-tracepoint",
    ],
)

# Manual: Depends on lttng-ust which has URCU issues
cc_test(
    name = "api0_hello_many",
    srcs = [
        "compile/api0/hello-many/hello-many.c",
        "compile/api0/hello-many/tp.c",
        "compile/api0/hello-many/ust_tests_hello_many.h",
    ],
    copts = COMMON_COPTS,
    local_defines = COMMON_DEFINES,
    tags = ["manual"],
    deps = [
        "@lttng-ust//:lttng-ust",
        "@lttng-ust//:lttng-ust-tracepoint",
    ],
)

# Manual: Depends on lttng-ust which has URCU issues
cc_test(
    name = "api0_ctf_types",
    srcs = [
        "compile/api0/ctf-types/ctf-types.c",
        "compile/api0/ctf-types/tp.c",
        "compile/api0/ctf-types/ust_tests_ctf_types.h",
    ],
    copts = COMMON_COPTS,
    local_defines = COMMON_DEFINES,
    tags = ["manual"],
    deps = [
        "@lttng-ust//:lttng-ust",
        "@lttng-ust//:lttng-ust-tracepoint",
    ],
)

# Manual: Depends on lttng-ust which has URCU issues
cc_test(
    name = "api0_same_line_tracepoint",
    srcs = [
        "compile/api0/same_line_tracepoint/same_line_tracepoint.c",
        "compile/api0/same_line_tracepoint/ust_tests_sameline.h",
    ],
    copts = COMMON_COPTS,
    local_defines = COMMON_DEFINES,
    tags = ["manual"],
    deps = [
        "@lttng-ust//:lttng-ust",
        "@lttng-ust//:lttng-ust-tracepoint",
    ],
)

# Manual: Depends on lttng-ust which has URCU issues
cc_test(
    name = "api0_hello_cxx",
    srcs = [
        "compile/api0/hello.cxx/hello.cpp",
        "compile/api0/hello.cxx/tp-cpp.cpp",
        "compile/api0/hello.cxx/ust_tests_hello.h",
    ],
    copts = [
        "-std=c++11",
        "-fPIC",
    ],
    local_defines = COMMON_DEFINES,
    tags = ["manual"],
    deps = [
        "@lttng-ust//:lttng-ust",
        "@lttng-ust//:lttng-ust-tracepoint",
    ],
)

# Manual: Depends on lttng-ust which has URCU issues
cc_test(
    name = "api1_hello",
    srcs = [
        "compile/api1/hello/hello.c",
        "compile/api1/hello/tp.c",
        "compile/api1/hello/ust_tests_hello.h",
    ],
    copts = COMMON_COPTS,
    local_defines = COMMON_DEFINES,
    tags = ["manual"],
    deps = [
        "@lttng-ust//:lttng-ust",
        "@lttng-ust//:lttng-ust-tracepoint",
    ],
)

# Manual: Depends on lttng-ust which has URCU issues
cc_test(
    name = "api1_hello_many",
    srcs = [
        "compile/api1/hello-many/hello-many.c",
        "compile/api1/hello-many/tp.c",
        "compile/api1/hello-many/ust_tests_hello_many.h",
    ],
    copts = COMMON_COPTS,
    local_defines = COMMON_DEFINES,
    tags = ["manual"],
    deps = [
        "@lttng-ust//:lttng-ust",
        "@lttng-ust//:lttng-ust-tracepoint",
    ],
)

# Manual: Depends on lttng-ust which has URCU issues
cc_test(
    name = "api1_ust_fields",
    srcs = [
        "compile/api1/ust-fields/tp.c",
        "compile/api1/ust-fields/ust-fields.c",
        "compile/api1/ust-fields/ust_tests_ust_fields.h",
    ],
    copts = COMMON_COPTS,
    local_defines = COMMON_DEFINES,
    tags = ["manual"],
    deps = [
        "@lttng-ust//:lttng-ust",
        "@lttng-ust//:lttng-ust-tracepoint",
    ],
)

# Manual: Depends on lttng-ust which has URCU issues
cc_test(
    name = "api1_same_line_tracepoint",
    srcs = [
        "compile/api1/same_line_tracepoint/same_line_tracepoint.c",
        "compile/api1/same_line_tracepoint/ust_tests_sameline.h",
    ],
    copts = COMMON_COPTS,
    local_defines = COMMON_DEFINES,
    tags = ["manual"],
    deps = [
        "@lttng-ust//:lttng-ust",
        "@lttng-ust//:lttng-ust-tracepoint",
    ],
)

# Manual: Depends on lttng-ust which has URCU issues
cc_test(
    name = "api1_test_app_ctx",
    srcs = [
        "compile/api1/test-app-ctx/hello.c",
        "compile/api1/test-app-ctx/tp.c",
        "compile/api1/test-app-ctx/ust_tests_hello.h",
    ],
    copts = COMMON_COPTS,
    local_defines = COMMON_DEFINES,
    tags = ["manual"],
    deps = [
        "@lttng-ust//:lttng-ust",
        "@lttng-ust//:lttng-ust-tracepoint",
    ],
)

# Manual: Depends on lttng-ust which has URCU issues
cc_test(
    name = "api1_hello_cxx",
    srcs = [
        "compile/api1/hello.cxx/hello.cpp",
        "compile/api1/hello.cxx/tp-cpp.cpp",
        "compile/api1/hello.cxx/ust_tests_hello.h",
    ],
    copts = [
        "-std=c++11",
        "-fPIC",
    ],
    local_defines = COMMON_DEFINES,
    tags = ["manual"],
    deps = [
        "@lttng-ust//:lttng-ust",
        "@lttng-ust//:lttng-ust-tracepoint",
    ],
)

###############################################################################
# Regression Tests - Manual due to URCU issues
###############################################################################

# Manual: Used by regression tests with URCU issues
cc_library(
    name = "fake_ust",
    srcs = ["regression/abi0-conflict/fake-ust.c"],
    hdrs = ["regression/abi0-conflict/fake-ust.h"],
    copts = COMMON_COPTS,
    linkstatic = 1,
    local_defines = COMMON_DEFINES,
)

# Manual: Used by regression tests with URCU issues
cc_library(
    name = "libzero",
    srcs = [
        "regression/abi0-conflict/libzero.c",
        "regression/abi0-conflict/tp.c",
        "regression/abi0-conflict/ust_tests_hello.h",
    ],
    hdrs = ["regression/abi0-conflict/libzero.h"],
    copts = COMMON_COPTS,
    local_defines = COMMON_DEFINES,
    tags = ["manual"],
    deps = ["@lttng-ust//:lttng-ust"],
)

# Manual: Used by regression tests with URCU issues
cc_library(
    name = "libone",
    srcs = [
        "regression/abi0-conflict/libone.c",
        "regression/abi0-conflict/tp.c",
        "regression/abi0-conflict/ust_tests_hello.h",
    ],
    hdrs = ["regression/abi0-conflict/libone.h"],
    copts = COMMON_COPTS,
    local_defines = COMMON_DEFINES,
    tags = ["manual"],
    deps = ["@lttng-ust//:lttng-ust"],
)

# Manual: Depends on lttng-ust
cc_binary(
    name = "app_ust",
    srcs = ["regression/abi0-conflict/app_ust.c"],
    copts = COMMON_COPTS,
    local_defines = COMMON_DEFINES,
    tags = ["manual"],
    deps = [
        ":libone",
        ":libzero",
        "@lttng-ust//:lttng-ust",
    ],
)

# Manual: For regression testing
cc_binary(
    name = "app_noust",
    srcs = ["regression/abi0-conflict/app_noust.c"],
    copts = COMMON_COPTS,
    local_defines = COMMON_DEFINES,
    tags = ["manual"],
    deps = [
        ":fake_ust",
        ":libone",
        ":libzero",
    ],
)

# Manual: Depends on lttng-ust
cc_binary(
    name = "app_ust_dlopen",
    srcs = ["regression/abi0-conflict/app_ust_dlopen.c"],
    copts = COMMON_COPTS,
    linkopts = ["-ldl"],
    local_defines = COMMON_DEFINES,
    tags = ["manual"],
    deps = [
        ":libzero",
        "@lttng-ust//:lttng-ust",
    ],
)

# Manual: For regression testing
cc_binary(
    name = "app_noust_dlopen",
    srcs = ["regression/abi0-conflict/app_noust_dlopen.c"],
    copts = COMMON_COPTS,
    linkopts = ["-ldl"],
    local_defines = COMMON_DEFINES,
    tags = ["manual"],
    deps = [
        ":fake_ust",
        ":libzero",
    ],
)

###############################################################################
# Benchmark - Manual
###############################################################################

# Manual: Depends on lttng-ust which has URCU issues
cc_binary(
    name = "benchmark",
    srcs = [
        "benchmark/bench.c",
        "benchmark/tp.c",
        "benchmark/ust_tests_benchmark.h",
    ],
    copts = COMMON_COPTS,
    local_defines = COMMON_DEFINES,
    tags = ["manual"],
    deps = [
        "@lttng-ust//:lttng-ust",
        "@lttng-ust//:lttng-ust-tracepoint",
    ],
)
